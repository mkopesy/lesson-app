<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø±ÙˆØ³ÙŠ - Ù…Ø­Ù…Ø¯</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø¯Ø±ÙˆØ³ÙŠ">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3426/3426653.png">
    <meta name="theme-color" content="#4f46e5">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; 
            --bg: #f8fafc; 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            padding: 15px;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 600px; margin: auto; }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: none;
            color: #64748b;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 25px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: bold; }

        input, select, textarea { 
            width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; 
            box-sizing: border-box; font-family: 'Tajawal'; outline: none; font-size: 16px;
        }

        input:focus, select:focus, textarea:focus { border-color: var(--primary); }

        .save-btn, .btn-primary { 
            width: 100%; padding: 16px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: bold;
            transition: 0.2s;
            margin-top: 10px;
        }

        .save-btn:active, .btn-primary:active { transform: scale(0.96); }

        .record-card { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            padding: 16px; background: white; margin-bottom: 12px; border-radius: 15px;
            border-right: 5px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .info strong { font-size: 16px; color: #1e293b; display: block; }
        .tag { background: #eef2ff; color: var(--primary); padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        
        .price { color: #10b981; font-weight: 800; font-size: 18px; }

        .delete-btn, .btn-icon { 
            color: #f87171; background: none; border: none; font-size: 22px; padding: 5px; cursor: pointer; 
        }

        .btn-icon.green { color: #10b981; }
        .btn-icon.blue { color: #4f46e5; }

        .footer { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; 
            color: white; padding: 20px; text-align: center; font-weight: bold; 
            font-size: 20px; border-radius: 20px 20px 0 0;
        }

        .backup-section { text-align: center; margin-bottom: 20px; }
        .backup-btn { background: #f1f5f9; color: #475569; border: none; padding: 8px 15px; border-radius: 10px; font-size: 12px; cursor: pointer; margin: 5px; }

        /* Statistics */
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-right: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-label { color: #64748b; font-size: 12px; font-weight: bold; }
        .stat-value { color: var(--primary); font-size: 24px; font-weight: bold; margin-top: 5px; }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-bar input {
            flex: 1;
        }

        /* Monthly Report */
        .month-item {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .month-info strong {
            display: block;
            font-size: 16px;
            color: #1e293b;
        }

        .month-count {
            color: #64748b;
            font-size: 13px;
        }

        .alert-box {
            background: #fef3c7;
            border-right: 4px solid var(--warning);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            color: #92400e;
            font-size: 14px;
        }

        .alert-box.danger {
            background: #fee2e2;
            border-right-color: var(--danger);
            color: #991b1b;
        }

        .contact-btn {
            display: inline-block;
            padding: 8px 15px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px 5px 5px 0;
        }

        .contact-btn.whatsapp {
            background: #25d366;
            color: white;
        }

        .contact-btn.email {
            background: #ea4335;
            color: white;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #475569;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sort-btn {
            padding: 8px 15px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #475569;
            margin-top: 10px;
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0;">Ù…Ù†Ø¸Ù… Ø¯Ø±ÙˆØ³ Ù…Ø­Ù…Ø¯ ğŸ“</h2>
        <p style="margin:5px 0 0 0; opacity: 0.8; font-size: 14px;">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('add')">â• Ø¥Ø¶Ø§ÙØ©</button>
        <button class="tab-btn" onclick="switchTab('records')">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="tab-btn" onclick="switchTab('reports')">ğŸ“… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button class="tab-btn" onclick="switchTab('alerts')">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
    </div>

    <!-- Tab 1: Add New Record -->
    <div id="add" class="tab-content active">
        <div class="card">
            <h3 style="margin-top:0;">Ø¥Ø¶Ø§ÙØ© Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            
            <div class="input-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                <input type="text" id="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" list="listNames">
                <datalist id="listNames"></datalist>
            </div>

            <div class="input-group">
                <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³</label>
                <input type="tel" id="phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>

            <div class="input-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>

            <div class="input-group">
                <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <input type="text" id="subject" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
            </div>

            <div style="display: flex; gap: 10px;">
                <div class="input-group" style="flex: 1;">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="val" placeholder="0">
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="date">
                </div>
            </div>

            <div class="input-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" rows="3"></textarea>
            </div>

            <button class="save-btn" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© âœ…</button>
        </div>
    </div>

    <!-- Tab 2: Records & Search -->
    <div id="records" class="tab-content">
        <div class="card">
            <h3 style="margin-top:0;">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." onkeyup="filterRecords()">
            </div>

            <div style="margin-bottom: 15px;">
                <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±:</label>
                <select id="monthFilter" onchange="filterRecords()" style="margin-top: 5px;">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label>ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                <button class="sort-btn active" onclick="setSortOrder('newest')">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</button>
                <button class="sort-btn" onclick="setSortOrder('oldest')">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</button>
            </div>

            <div id="recordsArea"></div>
        </div>
    </div>

    <!-- Tab 3: Statistics -->
    <div id="stats" class="tab-content">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
            
            <div class="stat-box">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ</div>
                <div class="stat-value" id="totalSessions">0</div>
            </div>

            <div class="stat-box">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
                <div class="stat-value" id="totalIncome" style="color: #10b981;">0 Ø¬.Ù…</div>
            </div>

            <div class="stat-box">
                <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                <div class="stat-value" id="totalStudents">0</div>
            </div>

            <h4 style="margin-top: 25px; margin-bottom: 15px;">ğŸ–ï¸ Ø£ÙƒØ«Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø¶ÙˆØ±Ø§Ù‹</h4>
            <div id="topStudents"></div>

            <h4 style="margin-top: 25px; margin-bottom: 15px;">ğŸ’° Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø­ØµØµ</h4>
            <div id="topPrices"></div>
        </div>
    </div>

    <!-- Tab 4: Monthly Reports -->
    <div id="reports" class="tab-content">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
            <div id="monthlyReports"></div>
        </div>
    </div>

    <!-- Tab 5: Alerts & Reminders -->
    <div id="alerts" class="tab-content">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª</h3>
            
            <div style="margin-bottom: 20px;">
                <label>ØªØ¹ÙŠÙŠÙ† Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø¬.Ù…):</label>
                <input type="number" id="alertThreshold" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" style="margin-top: 5px;">
                <button class="btn-primary" onclick="setAlertThreshold()" style="width: 100%; margin-top: 10px;">ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
            </div>

            <div id="alertsContainer"></div>
        </div>
    </div>

    <!-- Backup Section -->
    <div class="backup-section" style="margin-top: 30px;">
        <button class="backup-btn" onclick="exportData()">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ğŸ“¥</button>
        <button class="backup-btn" onclick="importData()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ğŸ“¤</button>
        <button class="backup-btn" onclick="clearAllData()" style="color: #ef4444;">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ—‘ï¸</button>
    </div>
</div>

<div class="footer">
    Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span> Ø¬.Ù…
</div>

<input type="file" id="importFile" style="display:none;" accept=".json" onchange="handleImport()">

<script>
    const STORAGE_KEY = 'MOHAMMED_TEACHER_DB_V2';
    const ALERT_KEY = 'ALERT_THRESHOLD';
    const SORT_KEY = 'SORT_ORDER';
    let data = [];
    let alertThreshold = 0;
    let sortOrder = 'newest';
    let currentFilter = { search: '', month: '' };

    window.onload = function() {
        loadData();
        loadAlertThreshold();
        loadSortOrder();
        document.getElementById('date').valueAsDate = new Date();
        populateMonthFilter();
        renderAll();
    };

    function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        try {
            data = raw ? JSON.parse(raw) : [];
        } catch (e) {
            data = [];
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
    }

    function loadAlertThreshold() {
        alertThreshold = parseInt(localStorage.getItem(ALERT_KEY)) || 0;
    }

    function loadSortOrder() {
        sortOrder = localStorage.getItem(SORT_KEY) || 'newest';
    }

    function setSortOrder(order) {
        sortOrder = order;
        localStorage.setItem(SORT_KEY, order);
        
        // Update button styles
        document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        renderRecords();
    }

    function saveData() {
        const n = document.getElementById('name').value.trim();
        const p = document.getElementById('phone').value.trim();
        const e = document.getElementById('email').value.trim();
        const s = document.getElementById('subject').value.trim();
        const v = document.getElementById('val').value;
        const d = document.getElementById('date').value;
        const no = document.getElementById('notes').value.trim();

        if (!n || !v || !d) {
            alert("ÙŠØ§ Ù…Ø­Ù…Ø¯ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");
            return;
        }

        const entry = {
            id: Date.now(),
            name: n,
            phone: p,
            email: e,
            subject: s || 'Ø¹Ø§Ù…',
            val: parseFloat(v),
            date: d,
            notes: no
        };

        data.unshift(entry);
        sync();
        
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('email').value = '';
        document.getElementById('subject').value = '';
        document.getElementById('val').value = '';
        document.getElementById('notes').value = '';
        
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­!');
    }

    function deleteEntry(id) {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­ØµØ©ØŸ")) {
            data = data.filter(item => item.id !== id);
            sync();
        }
    }

    function sync() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        renderAll();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    function renderAll() {
        renderFooter();
        renderRecords();
        renderStats();
        renderReports();
        renderAlerts();
    }

    function renderFooter() {
        const totalSpan = document.getElementById('total');
        let totalVal = 0;
        data.forEach(item => totalVal += item.val);
        totalSpan.innerText = totalVal.toLocaleString();
    }

    function getSortedData(dataArray) {
        const sorted = [...dataArray];
        if (sortOrder === 'newest') {
            sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
        } else {
            sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        return sorted;
    }

    function renderRecords() {
        const area = document.getElementById('recordsArea');
        const listNames = document.getElementById('listNames');
        
        area.innerHTML = '';
        const names = [...new Set(data.map(i => i.name))];
        listNames.innerHTML = names.map(n => `<option value="${n}">`).join('');

        let filtered = data;
        
        if (currentFilter.search) {
            filtered = filtered.filter(item => 
                item.name.includes(currentFilter.search) || 
                item.subject.includes(currentFilter.search)
            );
        }

        if (currentFilter.month) {
            filtered = filtered.filter(item => item.date.startsWith(currentFilter.month));
        }

        filtered = getSortedData(filtered);

        if (filtered.length === 0) {
            area.innerHTML = '<p style="text-align:center; color:#94a3b8; margin-top:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ</p>';
            return;
        }

        filtered.forEach(item => {
            const whatsappUrl = item.phone ? `https://wa.me/20${item.phone.replace(/^0/, '')}` : null;
            const mailtoUrl = item.email ? `mailto:${item.email}` : null;

            area.innerHTML += `
                <div class="record-card">
                    <div class="info" style="flex: 1;">
                        <strong>${item.name}</strong>
                        <span class="tag">${item.subject}</span>
                        <small style="display:block; color:#94a3b8; margin-top:5px;">ğŸ“… ${item.date}</small>
                        ${item.notes ? `<small style="display:block; color:#64748b; margin-top:3px;">ğŸ“ ${item.notes}</small>` : ''}
                        <div class="flex-row">
                            ${whatsappUrl ? `<a href="${whatsappUrl}" target="_blank" class="contact-btn whatsapp">ğŸ’¬ ÙˆØ§ØªØ³</a>` : ''}
                            ${mailtoUrl ? `<a href="${mailtoUrl}" class="contact-btn email">ğŸ“§ Ø¨Ø±ÙŠØ¯</a>` : ''}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction: column; align-items:center; gap:15px; margin-right: 15px;">
                        <span class="price">${item.val}</span>
                        <button class="delete-btn" onclick="deleteEntry(${item.id})">Ã—</button>
                    </div>
                </div>
            `;
        });
    }

    function renderStats() {
        if (data.length === 0) {
            document.getElementById('totalSessions').innerText = '0';
            document.getElementById('totalIncome').innerText = '0 Ø¬.Ù…';
            document.getElementById('totalStudents').innerText = '0';
            return;
        }

        let totalVal = 0;
        const studentStats = {};

        data.forEach(item => {
            totalVal += item.val;
            studentStats[item.name] = (studentStats[item.name] || 0) + 1;
        });

        document.getElementById('totalSessions').innerText = data.length;
        document.getElementById('totalIncome').innerText = totalVal.toLocaleString() + ' Ø¬.Ù…';
        document.getElementById('totalStudents').innerText = Object.keys(studentStats).length;

        const topStudentsArray = Object.entries(studentStats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        let topStudentsHTML = '';
        topStudentsArray.forEach(([name, count]) => {
            topStudentsHTML += `
                <div class="stat-box">
                    <strong>${name}</strong>
                    <small style="color:#64748b;">${count} Ø­ØµØ©</small>
                </div>
            `;
        });
        document.getElementById('topStudents').innerHTML = topStudentsHTML || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';

        const topPricesArray = [...data]
            .sort((a, b) => b.val - a.val)
            .slice(0, 5);

        let topPricesHTML = '';
        topPricesArray.forEach(item => {
            topPricesHTML += `
                <div class="stat-box">
                    <strong>${item.name}</strong>
                    <small style="color:#64748b;">${item.date} - ${item.subject}</small>
                    <div class="price" style="margin-top: 8px;">${item.val} Ø¬.Ù…</div>
                </div>
            `;
        });
        document.getElementById('topPrices').innerHTML = topPricesHTML || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    }

    function renderReports() {
        const monthlyData = {};

        data.forEach(item => {
            const month = item.date.substring(0, 7);
            if (!monthlyData[month]) {
                monthlyData[month] = { count: 0, total: 0 };
            }
            monthlyData[month].count += 1;
            monthlyData[month].total += item.val;
        });

        const months = Object.keys(monthlyData).sort().reverse();
        let reportsHTML = '';

        months.forEach(month => {
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
            const stats = monthlyData[month];

            reportsHTML += `
                <div class="month-item">
                    <div>
                        <strong>${monthName}</strong>
                        <div class="month-count">${stats.count} Ø­ØµØ©</div>
                    </div>
                    <div style="text-align: left; color: #10b981; font-weight: bold; font-size: 18px;">
                        ${stats.total.toLocaleString()} Ø¬.Ù…
                    </div>
                </div>
            `;
        });

        document.getElementById('monthlyReports').innerHTML = reportsHTML || '<p style="text-align:center; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    }

    function renderAlerts() {
        if (alertThreshold === 0) {
            document.getElementById('alertsContainer').innerHTML = '<p style="text-align:center; color:#94a3b8;">Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯</p>';
            return;
        }

        const studentPayments = {};
        data.forEach(item => {
            if (!studentPayments[item.name]) {
                studentPayments[item.name] = 0;
            }
            studentPayments[item.name] += item.val;
        });

        let alertsHTML = '';
        let hasAlerts = false;

        Object.entries(studentPayments).forEach(([name, total]) => {
            const alertColor = total < alertThreshold / 2 ? 'danger' : '';
            if (total < alertThreshold) {
                hasAlerts = true;
                const remaining = (alertThreshold - total).toLocaleString();
                alertsHTML += `
                    <div class="alert-box ${alertColor}">
                        <strong>${name}</strong><br>
                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()} Ø¬.Ù…<br>
                        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining} Ø¬.Ù… Ù…Ù† Ø§Ù„Ù‡Ø¯Ù ${alertThreshold.toLocaleString()} Ø¬.Ù…
                    </div>
                `;
            }
        });

        if (!hasAlerts) {
            alertsHTML = '<p style="text-align:center; color:#10b981; font-weight:bold;">âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØµÙ„ÙˆØ§ Ù„Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</p>';
        }

        document.getElementById('alertsContainer').innerHTML = alertsHTML;
    }

    function setAlertThreshold() {
        const val = document.getElementById('alertThreshold').value;
        if (val && val > 0) {
            alertThreshold = parseInt(val);
            localStorage.setItem(ALERT_KEY, alertThreshold);
            alert('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ù†Ø¬Ø§Ø­!');
            renderAlerts();
        } else {
            alert('âš ï¸ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©');
        }
    }

    function filterRecords() {
        currentFilter.search = document.getElementById('searchInput').value.toLowerCase();
        currentFilter.month = document.getElementById('monthFilter').value;
        renderRecords();
    }

    function populateMonthFilter() {
        const months = new Set();
        data.forEach(item => {
            months.add(item.date.substring(0, 7));
        });

        const select = document.getElementById('monthFilter');
        const sortedMonths = Array.from(months).sort().reverse();
        
        sortedMonths.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
            option.textContent = monthName;
            select.appendChild(option);
        });
    }

    function exportData() {
        if (data.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Ø¯Ø±ÙˆØ³ÙŠ_Ù…Ø­Ù…Ø¯_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData() {
        document.getElementById('importFile').click();
    }

    function handleImport() {
        const file = document.getElementById('importFile').files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ØŸ\n(ØªØ£ÙƒÙŠØ¯ = Ø¯Ù…Ø¬ØŒ Ø¥Ù„ØºØ§Ø¡ = Ø§Ø³ØªØ¨Ø¯Ø§Ù„)')) {
                    data = [...data, ...imported];
                } else {
                    data = imported;
                }
                sync();
                alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (err) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù');
            }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if (confirm("ØªØ­Ø°ÙŠØ±! Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            data = [];
            sync();
            alert('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }
</script>

</body>
</html>